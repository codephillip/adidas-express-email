# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Deploy to GKE

on:
  push:
    branches:
      - main

env:
  IMAGE: adidas_express_email
  REGISTRY: us.gcr.io
  CONTAINER: adidas-express-email

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
    steps:
      - uses: actions/checkout@v2
      - name: Deploy
        uses: shashank0202/docker-build-push-gcr-update-gke-deployment-action@v1.0
        with:
          service_account: ${{ secrets.GCLOUD_AUTH }}
          zone: ${{ secrets.GKE_ZONE }}
          project_id: ${{ secrets.GKE_PROJECT }}
          registry: ${{ env.REGISTRY }}
          image_name: ${{ env.IMAGE }}
          cluster: ${{ secrets.GKE_CLUSTER }}
          namespace: ${{ secrets.GKE_NAMESPACE }}
          deployment: ${{ secrets.GKE_DEPLOYMENT }}
          # Container name can be difficult to find, let alone understand
          # https://stackoverflow.com/questions/58516617/kubectl-set-image-error-arguments-in-resource-name-form-may-not-have-more-than
          container: ${{ env.CONTAINER }}
      - run: |-
          gcloud --quiet auth configure-docker

      # Get the GKE credentials so we can deploy to the cluster
      - uses: google-github-actions/get-gke-credentials@fb08709ba27618c31c09e014e1d8364b02e5042e
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          credentials: ${{ secrets.GCLOUD_AUTH }}
      # Deploy the Docker image to the GKE cluster
      - name: Restart deployment
        run: kubectl rollout restart deployment ${{ secrets.GKE_DEPLOYMENT }}